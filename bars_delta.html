<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="bars_delta.css">
    <script type="text/javascript" src="countUp.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="jquery-ui-1.12.1/jquery-ui.css">
    <script src="jquery-ui-1.12.1/external/jquery/jquery.js"></script>
    <script src="jquery-ui-1.12.1/jquery-ui.js"></script>
</head>
<body>

<div id="appbar">

</div>
<div id="list">
    <div class="list_item">
        <span class="icon_container" id="food"></span>
        <span class="content_container">
            <span class="category_name">Mancare</span>
            <span class="delta"></span>
            <span class="amount" id="food_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>

    </div>
    <div class="list_item">
        <span class="icon_container" id="card"></span>
        <span class="content_container">
            <span class="category_name">Retragere numerar</span>
            <span class="delta"></span>
            <span class="amount" id="card_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>
    <div class="list_item">
        <span class="icon_container" id="work"></span>
        <span class="content_container">
            <span class="category_name">Afaceri</span>
            <span class="delta"></span>
            <span class="amount" id="work_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>
    <div class="list_item">
        <span class="icon_container" id="shopping"></span>
        <span class="content_container">
            <span class="category_name">Cumparaturi</span>
            <span class="delta"></span>
            <span class="amount" id="shopping_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>
    <div class="list_item">
        <span class="icon_container" id="other"></span>
        <span class="content_container">
            <span class="category_name">Diverse</span>
            <span class="delta"></span>
            <span class="amount" id="other_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>
    <div class="list_item">
        <span class="icon_container" id="baby"></span>
        <span class="content_container">
            <span class="category_name">Copil</span>
            <span class="delta"></span>
            <span class="amount" id="baby_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>
    <div class="list_item">
        <span class="icon_container" id="car"></span>
        <span class="content_container">
            <span class="category_name">Transport</span>
            <span class="delta"></span>
            <span class="amount" id="car_amount"></span>
            <span class="currency">RON</span>
            <span class="contextual_container">
            </span>
        </span>
    </div>

</div>

<script>

    $(document).ready(function(){

        function skewedRandom() {
            const a = Math.pow(Math.random(), 2);
            if (Math.random() < 0.5) {
                return a;
            }
            return 1 - a;
        }

        var totalFinalAmount = 0;
        var maxInitialAmount = 0;
        var amountUpperLimit = 5000;
        var deltaUpperLimit = 3000;

        var initialAndDelta = [];
        var maxAnimationDuration = 500;
        var maxDeltaAnimationDuration = 1000;

        $(".list_item").each(function (index) {

            var initialAmountValue = Math.floor(skewedRandom() * amountUpperLimit);
            var deltaValue = Math.floor(skewedRandom() * deltaUpperLimit);
            initialAndDelta[index] = [initialAmountValue, deltaValue];
            totalFinalAmount += initialAmountValue;
            totalFinalAmount += deltaValue;


            if (initialAmountValue > maxInitialAmount) {
                maxInitialAmount = initialAmountValue;
            }
        });

        initialAndDelta.sort(function (a, b) {
            var finalA = a[0] + a[1];
            var finalB = b[0] + b[1];

            if (finalA > finalB) {
                return -1;
            }

            if (finalA == finalB) {
                return 0;
            }

            if (finalA < finalB) {
                return 1;
            }

        });

        $( ".list_item" ).each(function( index ) {
            $(this).find(".amount").first().text(initialAndDelta[index][0]);
        });

        var longestAnimation = 0;

        $( ".content_container" ).each(function( index ) {

            var initialAmountValue = initialAndDelta[index][0];
            var maxWidth = $(this).width();

            var barWidth = (initialAmountValue * maxWidth) / totalFinalAmount;
            var animationDuration = (initialAmountValue * maxAnimationDuration) / maxInitialAmount;
            initialAndDelta[index][2] = barWidth;

            var element = document.createElement('div');
            $(element).addClass("bar");
            $(element).appendTo($(this));

            $(element).animate({
                width: barWidth,

            }, animationDuration, "linear");

            if (animationDuration > longestAnimation){
                longestAnimation = animationDuration;
            }

        });

        setTimeout(function(){

            $( ".content_container" ).each(function( index ) {

                var deltaValue = initialAndDelta[index][1];
                var maxWidth = $(this).width();

                var deltaBarWidth = (deltaValue * maxWidth) / totalFinalAmount;
                var animationDuration = (deltaValue * maxDeltaAnimationDuration) / maxInitialAmount;

                var element = document.createElement('div');
                $(element).addClass("delta-bar").css('left', initialAndDelta[index][2] + 'px');
                $(element).appendTo($(this));

                var amountId = $(this).find(".amount").first().attr('id');

                //animate delta bar
                $(element).animate({
                    width: deltaBarWidth,

                }, animationDuration, "linear", function(){
                    $(element).removeClass('delta-bar');
                    $(element).addClass('bar');
                });

                // animate amount value
                var options = {
                    useEasing: false,
                    useGrouping: true,
                    separator: ',',
                    decimal: '.',
                };

                var initial = initialAndDelta[index][0];
                var delta = initialAndDelta[index][1];
                var amountAnimation = new CountUp(amountId, initial, (initial + delta), 0, animationDuration / 1000, options);
                amountAnimation.start();

            });

        }, longestAnimation);

    });





</script>

</body>
</html>
